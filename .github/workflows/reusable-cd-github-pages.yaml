# Reusable workflow for deploying multiple artifacts to GitHub Pages
# This workflow downloads multiple artifacts, merges them, and creates a unified index page
name: reusable-cd-github-pages

on:
  workflow_call:
    inputs:
      artifacts:
        description: |
          JSON array of artifact objects to deploy. Each object should contain:
          - name: Artifact name (required)
          - display_name: Display name for index page (required)
          - path: Subdirectory path in artifact (optional, defaults to artifact name)
          Example: '[{"name":"schemaspy-aurora_dev-dev","display_name":"Aurora Dev (PostgreSQL)","path":"aurora_dev"},{"name":"schemaspy-aurora_prd-prd","display_name":"Aurora Prd (PostgreSQL)","path":"aurora_prd"}]'
        required: true
        type: string
      index_title:
        description: "Title for the index page (default: 'Documentation')"
        required: false
        type: string
        default: "Documentation"
      index_description:
        description: "Description for the index page (default: 'Select an item to view documentation')"
        required: false
        type: string
        default: "Select an item to view documentation"

jobs:
  deploy-to-github-pages:
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Parse artifacts configuration
        id: parse-inputs
        run: |
          echo "Parsing artifacts configuration..."
          echo '${{ inputs.artifacts }}' | jq -c '.[]' > /tmp/artifacts.jsonl

          echo "Artifacts to process:"
          cat /tmp/artifacts.jsonl | jq -r '.name'

          echo "Total artifacts: $(cat /tmp/artifacts.jsonl | wc -l)"

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v6.0.0
        with:
          path: all-artifacts

      - name: Merge artifacts
        run: |
          echo "Merging multiple artifacts for GitHub Pages deployment"

          mkdir -p merged-pages

          # Process each artifact configuration
          while IFS= read -r artifact_json; do
            artifact_name=$(echo "${artifact_json}" | jq -r '.name')
            display_name=$(echo "${artifact_json}" | jq -r '.display_name')
            artifact_path_in_archive=$(echo "${artifact_json}" | jq -r '.path // .name')

            echo "Processing artifact: ${artifact_name}"
            echo "  Display name: ${display_name}"
            echo "  Path in archive: ${artifact_path_in_archive}"

            artifact_dir="all-artifacts/${artifact_name}"

            if [ ! -d "${artifact_dir}" ]; then
              echo "  ‚ö†Ô∏è  Warning: Artifact directory not found: ${artifact_dir}"
              continue
            fi

            # Determine source directory
            if [ -d "${artifact_dir}/${artifact_path_in_archive}" ]; then
              source_dir="${artifact_dir}/${artifact_path_in_archive}"
              echo "  ‚úÖ Found specific path: ${source_dir}"
            elif [ -d "${artifact_dir}" ]; then
              source_dir="${artifact_dir}"
              echo "  ‚úÖ Using entire artifact directory: ${source_dir}"
            else
              echo "  ‚ùå Error: Cannot find source directory"
              continue
            fi

            # Copy to merged output with artifact_path_in_archive as directory name
            target_dir="merged-pages/${artifact_path_in_archive}"
            echo "  üìÇ Copying to: ${target_dir}"

            mkdir -p "${target_dir}"
            cp -r "${source_dir}"/* "${target_dir}/" 2>/dev/null || cp -r "${source_dir}" "${target_dir}" 2>/dev/null || echo "  ‚ö†Ô∏è  Copy operation had issues"

            echo "  ‚úì Processed successfully"
            echo ""
          done < /tmp/artifacts.jsonl

          echo "Merged pages structure:"
          ls -lR merged-pages/

      - name: Create index page
        run: |
          echo "Creating unified index page with links to all items"

          cat > merged-pages/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${{ inputs.index_title }}</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
                max-width: 900px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f6f8fa;
                line-height: 1.6;
              }
              h1 {
                color: #24292f;
                border-bottom: 3px solid #0969da;
                padding-bottom: 15px;
                margin-bottom: 10px;
              }
              .description {
                color: #57606a;
                margin-bottom: 30px;
              }
              ul {
                list-style-type: none;
                padding: 0;
              }
              li {
                margin: 12px 0;
              }
              a {
                display: block;
                padding: 16px 20px;
                background-color: #ffffff;
                color: #0969da;
                text-decoration: none;
                border-radius: 6px;
                border: 1px solid #d0d7de;
                transition: all 0.2s ease;
                font-weight: 500;
              }
              a:hover {
                background-color: #0969da;
                color: #ffffff;
                border-color: #0969da;
                box-shadow: 0 3px 6px rgba(140,149,159,0.15);
                transform: translateY(-1px);
              }
              .meta {
                margin-top: 40px;
                padding: 16px;
                background-color: #ffffff;
                border-radius: 6px;
                border: 1px solid #d0d7de;
                font-size: 0.875em;
                color: #57606a;
              }
              .meta strong {
                color: #24292f;
              }
              .meta a {
                display: inline;
                padding: 0;
                background: none;
                border: none;
                color: #0969da;
                font-weight: normal;
              }
              .meta a:hover {
                background: none;
                color: #0550ae;
                text-decoration: underline;
                transform: none;
                box-shadow: none;
              }
            </style>
          </head>
          <body>
            <h1>üìö ${{ inputs.index_title }}</h1>
            <p class="description">${{ inputs.index_description }}</p>
            <ul>
          EOF

          # Add links for each artifact
          while IFS= read -r artifact_json; do
            display_name=$(echo "${artifact_json}" | jq -r '.display_name')
            artifact_path_in_archive=$(echo "${artifact_json}" | jq -r '.path // .name')

            if [ -d "merged-pages/${artifact_path_in_archive}" ]; then
              echo "              <li><a href=\"./${artifact_path_in_archive}/index.html\">${display_name}</a></li>" >> merged-pages/index.html
            fi
          done < /tmp/artifacts.jsonl

          cat >> merged-pages/index.html <<EOF
            </ul>
            <div class="meta">
              <strong>Generated:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")<br>
              <strong>Workflow:</strong> ${{ github.workflow }}<br>
              <strong>Run:</strong> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" target="_blank">#${{ github.run_number }}</a>
            </div>
          </body>
          </html>
          EOF

          echo "Index page created successfully"

      - name: Create buildinfo
        run: |
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > merged-pages/.buildinfo
          echo "Workflow: ${{ github.workflow }}" >> merged-pages/.buildinfo
          echo "Run ID: ${{ github.run_id }}" >> merged-pages/.buildinfo
          echo "Items:" >> merged-pages/.buildinfo
          while IFS= read -r artifact_json; do
            display_name=$(echo "${artifact_json}" | jq -r '.display_name')
            artifact_path=$(echo "${artifact_json}" | jq -r '.path // .name')
            echo "  - ${display_name} (${artifact_path})" >> merged-pages/.buildinfo
          done < /tmp/artifacts.jsonl

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae8b0fb0855d0112c7a492a7ae1f # v5.0.0

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: merged-pages

      - name: Exec Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      - name: Summary
        if: always()
        run: |
          echo "# GitHub Pages Deployment" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployed successfully to GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Items Deployed**:" >> $GITHUB_STEP_SUMMARY
            while IFS= read -r artifact_json; do
              display_name=$(echo "${artifact_json}" | jq -r '.display_name')
              artifact_path=$(echo "${artifact_json}" | jq -r '.path // .name')
              echo "- ${display_name} (\`${artifact_path}\`)" >> $GITHUB_STEP_SUMMARY
            done < /tmp/artifacts.jsonl
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: Access the index page to navigate to individual documentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
